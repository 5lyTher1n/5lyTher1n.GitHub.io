---
title: JarvisOJ_PWN_level2_64
date: 2019-11-19 21:58:11
tags:
- Sec
- CTF
- PWN
- JarvisOJ
categories:
- Sec
- CTF
- PWN
---

# 花絮 #
上午上课时写的，下午在折腾之前捡的垃圾。好像，今天的进度被拉跨了。。。
# 独立解题 #
和之前做的Level2差不多。但是这题是64位的。

**前排提醒，文章记录很乱，大概率对别人没什么帮助。愿意看就点下面吧，做好右上角的准备**
<!-- more -->

记得64位和32位主要是传参不一样。

- 32位传参只要考虑压栈就可以了。
- 64位则要考虑到用寄存器。

使用IDA查看汇编代码：
看到:
> mov edx,200h
> 
> mov rsi,rax
> 
> mov edi,0
> 
> call _read

猜测，前三个参数应该是分别使用edi、rsi、edx.

IDA可以找到system函数的地址和'/bin/sh'字符串的地址。那么只要考虑如何把字符串作为参数提供给edi寄存器，然后return到system函数的地址就可以了。

第一步：最开始期望的是构造出类似这样的语句：
> mov edi '/bin/sh'

后来想起来，字符串好像不能这样。操控的大多数是代表的地址。这样是行不通的。

第二步：在0x400555看到代码：
> mov edi offset _bss_start

想起来上一题，把'/bin/sh'写入到bss段的方法，但再想想，写入到bss段之前用到了read函数，而read函数需要3个参数，好像工作量并没有减少啊0.0这是换了一个新的问题。

第三步：想起来level4的两种payload的方法。也就是寻找pop和rnt，找到一个
> pop edi 
> 
> rnt


这样的代码就可以了。。。然后开始翻IDA~（我不知道怎么搜索）~没找到0.0

在0x4006B2处找到一个类似的：
> pop r15

但好像又不太对。
至此，卡壳。。。去翻了题解。

# 解题报告 #
学到了还有ROPgadget这个工具。。。

直接可以用ROPgadget来查找相关字符串

> ROPgadget --binary ./level2_64 --string "/bin/sh"
这个可以看到'/bin/sh'的地址
ROPgadget --binary ./level2_64 --only "pop|ret" 这个可以看到包含pop+ret的字符串和地址

然后发现在0x4006B3的地址上找到了要想要的代码。

*咦这个地址看起来有点熟悉啊，和上面那个差了一点啊0.0而且，IDA找不到哎=。=*


> (11.21留:今天看到一个题解说到了这个点：
pop r15，retn的字节码是：
0x41 0x5f 0xc3
	而pop rdi,ret的字节码是：
	0x5f 0xc3
	所以，可以从r15处取得rdi）太有趣啦~有逻辑性又有戏剧性
    

确定这个后，就很方便构造payload了
大致是：


> payload = pad + p64(tools_addr) + p64(sh_addr) + p(system_addr)

然后可以cat flag了~

# 总结 #
1. 64位参数传递约定：前六参数按顺序存储在寄存器里，依次是rdi、rsi、rdx、rcx、r8、r9。第七个及以后会压入栈中。（~顺序呢？和32位一样从右往左吗？~顺序和32位的一样，也是从右往左开始，也对，和32位一样也挺好的）
2. ROPgadget好厉害，才学到一个词是ROP，面向return编程。之前好像看到过，但没在意，现在感觉很有趣，依然，这个工具不太熟悉，需要熟悉下~
3. 这个payload是我自己写的，也确实能get到flag。~但是，总感觉迷迷糊糊的。说实话，我并不太清楚这个payload传输进去后的执行步骤，当时是想适配一个pop，那把sh_addr压入栈。一个ret，那把system函数地址给过去。但具体怎么样要搞清楚！~看了几篇WP加上一些资料，大概算是想通了。首先填充是从低地址往高地址填充的，方向是和扩栈相反。那么，根据payload的设置，首先是一堆pad填充区间。然后栈顶到栈底的顺序，依次是p64(tools_addr)，p64(sh_addr)和p64(system_addr)。先执行第一个，此时tools_addr已经出栈了。执行时发现是个地址跳转到相应位置执行命令（*猜的，应该是这样吧。。。*）这时栈顶是sh_addr，pop edi就可以把"/bin/sh"给edi寄存器，ret又到了system函数地址，就完成了需要的操作。


下午没做题有点亏，但办的。。。也算正事。。。吧。。。つ﹏⊂

这些问题等着明天搞吧，明天要搞清楚~


**人一我百，人十我万，永不放弃，加油！**